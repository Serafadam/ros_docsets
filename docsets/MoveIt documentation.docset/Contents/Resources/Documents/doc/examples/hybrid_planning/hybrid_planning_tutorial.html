<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hybrid Planning &mdash; MoveIt documentation  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/override.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="canonical" href="https://moveit.picknik.ai/rolling/doc/examples/hybrid_planning/hybrid_planning_tutorial.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Realtime Arm Servoing" href="../realtime_servo/realtime_servo_tutorial.html" />
    <link rel="prev" title="Dual Arms with MoveIt" href="../dual_arms/dual_arms_tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html">
            <img src="../../../_static/rolling-small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#movegroup-ros-wrappers-in-c">MoveGroup - ROS Wrappers in C++</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#using-moveit-directly-through-the-c-api">Using MoveIt Directly Through the C++ API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#integration-with-a-new-robot">Integration with a New Robot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#configuration">Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#miscellaneous">Miscellaneous</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../benchmarking/benchmarking_tutorial.html">Benchmarking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dual_arms/dual_arms_tutorial.html">Dual Arms with MoveIt</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Hybrid Planning</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-hybrid-planning">What is Hybrid Planning?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l4"><a class="reference internal" href="#customizing-the-hybrid-planning-architecture">Customizing the Hybrid Planning Architecture</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#global-and-local-motion-planning">Global and Local Motion Planning</a></li>
<li class="toctree-l5"><a class="reference internal" href="#planning-logic-and-reactive-behavior">Planning Logic and Reactive Behavior</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../realtime_servo/realtime_servo_tutorial.html">Realtime Arm Servoing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tests/tests_tutorial.html">Integration/Unit Tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_guides/how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_contribute/how_to_contribute.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MoveIt documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../examples.html">Examples</a></li>
      <li class="breadcrumb-item active">Hybrid Planning</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ros-planning/moveit2_tutorials/blob/main/doc/examples/hybrid_planning/hybrid_planning_tutorial.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             


  <div class="section" id="hybrid-planning">
<h1>Hybrid Planning<a class="headerlink" href="#hybrid-planning" title="Permalink to this headline"></a></h1>
<p>In this section, you will learn how to use  Moveit 2’s <em>Hybrid Planning</em> feature.</p>
<p>Hybrid Planning enables you to (re)plan and execute robot motions online with MoveIt 2 and to add more planning logic into your robot’s motion planning pipeline.</p>
<a class="reference internal image-reference" href="../../../_images/replanning_demo.gif"><img alt="../../../_images/replanning_demo.gif" src="../../../_images/replanning_demo.gif" style="width: 500pt;" /></a>
<div class="section" id="what-is-hybrid-planning">
<h2>What is Hybrid Planning?<a class="headerlink" href="#what-is-hybrid-planning" title="Permalink to this headline"></a></h2>
<p>Hybrid Planning uses a (slower) global motion planner in combination with a (faster) local motion planner to enable a robot to solve different tasks online and in dynamic environments.
Typically, the global motion planner is used to create an initial motion plan offline and to re-plan it if the global solution gets invalidated. The local planner adapts the global solution to local constraints and reacts immediately to changes in the environment. A more detailed description of the architecture can be found in the <a class="reference internal" href="../../concepts/hybrid_planning/hybrid_planning.html"><span class="doc">Hybrid Planning Concepts Page</span></a>.</p>
<p>The architecture that enables <em>Hybrid Planning</em> in MoveIt 2 can be seen below:</p>
<a class="reference internal image-reference" href="../../../_images/hybrid_planning_architecture1.png"><img alt="../../../_images/hybrid_planning_architecture1.png" src="../../../_images/hybrid_planning_architecture1.png" style="width: 700px;" /></a>
<p>The <em>Hybrid Planning Manager</em> provides an API for <em>Hybrid Planning requests</em>, implements the high-level planning logic and coordinates both planners and their interaction.
Global planning requests are responded by the <em>Global Planner Component</em> which solves a given planning problem and publishes the solution. The <em>Local Planner Component</em> processes incoming global trajectory updates and solves the local planning problem at each iteration.
The main advantages of using the architecture are:</p>
<ul class="simple">
<li><p>Global and local constrained motion planning problems can be handled separately</p></li>
<li><p>Online motion planning is possible with the local planner</p></li>
<li><p>Reactive re-planning in dynamic or unknown environments</p></li>
</ul>
</div>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline"></a></h2>
<p>If you haven’t already done so, make sure you’ve completed the steps in <a class="reference internal" href="../../tutorials/getting_started/getting_started.html"><span class="doc">Getting Started</span></a>.</p>
<p>To start the hybrid planning demo simply run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ros2</span> <span class="n">launch</span> <span class="n">moveit_hybrid_planning</span> <span class="n">hybrid_planning_demo</span><span class="o">.</span><span class="n">launch</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>You should see a similar behavior as in the example GIF above without the replanning.</p>
<p>To interact with the architecture you simply need to send a <em>Hybrid Planning Request</em> to an action server offered by the <em>Hybrid Planning Manager</em> as seen in the <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/test/hybrid_planning_demo_node.cpp#L245">hybrid_planning_test_node</a>.</p>
<p>Let’s change this behavior such that the architecture replans the invalidated trajectory. To do so, just change the <em>planner_logic_plugin</em> by replacing the plugin name in the <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/test/config/hybrid_planning_manager.yaml">demo configuration</a> with “moveit_hybrid_planning/ReplanInvalidatedTrajectory” and rebuild the package :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">colcon</span> <span class="n">build</span> <span class="o">--</span><span class="n">packages</span><span class="o">-</span><span class="n">select</span> <span class="n">moveit2_tutorials</span>
</pre></div>
</div>
<p>After re-running the launch command from above, you should see that the architecture replans the invalidated trajectory.</p>
<p>To include the Hybrid Planning Architecture into you project you need to add a <em>Hybrid Planning</em> component node with the necessary parameters into one of your launch files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate launch description with multiple components</span>
<span class="n">container</span> <span class="o">=</span> <span class="n">ComposableNodeContainer</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;hybrid_planning_container&quot;</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="n">package</span><span class="o">=</span><span class="s2">&quot;rclcpp_components&quot;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s2">&quot;component_container&quot;</span><span class="p">,</span>
    <span class="n">composable_node_descriptions</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ComposableNode</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s2">&quot;moveit_hybrid_planning&quot;</span><span class="p">,</span>
            <span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;moveit::hybrid_planning::GlobalPlannerComponent&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;global_planner&quot;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                <span class="n">global_planner_param</span><span class="p">,</span>
                <span class="n">robot_description</span><span class="p">,</span>
                <span class="n">robot_description_semantic</span><span class="p">,</span>
                <span class="n">kinematics_yaml</span><span class="p">,</span>
                <span class="n">ompl_planning_pipeline_config</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="n">ComposableNode</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s2">&quot;moveit_hybrid_planning&quot;</span><span class="p">,</span>
            <span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;moveit::hybrid_planning::LocalPlannerComponent&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;local_planner&quot;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                <span class="n">local_planner_param</span><span class="p">,</span>
                <span class="n">robot_description</span><span class="p">,</span>
                <span class="n">robot_description_semantic</span><span class="p">,</span>
                <span class="n">kinematics_yaml</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">),</span>
        <span class="n">ComposableNode</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s2">&quot;moveit_hybrid_planning&quot;</span><span class="p">,</span>
            <span class="n">plugin</span><span class="o">=</span><span class="s2">&quot;moveit::hybrid_planning::HybridPlanningManager&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;hybrid_planning_manager&quot;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">hybrid_planning_manager_param</span><span class="p">],</span>
        <span class="p">),</span>
    <span class="p">],</span>
    <span class="n">output</span><span class="o">=</span><span class="s2">&quot;screen&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="customizing-the-hybrid-planning-architecture">
<h2>Customizing the Hybrid Planning Architecture<a class="headerlink" href="#customizing-the-hybrid-planning-architecture" title="Permalink to this headline"></a></h2>
<p>As the rest of Moveit 2, the <em>Hybrid Planning Architecture</em> is designed to be highly customizable while also offering the possibility to easily re-use existing solutions. Each of the architecture’s components is a ROS 2 node and can be completely replaced by your own custom ROS 2 node as long as it offers the API required by the other nodes. Each component’s runtime behavior is defined by plugins. This section focuses on the customization of the <em>Hybrid Planning Architecture</em> by implementing your own plugins.</p>
<div class="section" id="global-and-local-motion-planning">
<h3>Global and Local Motion Planning<a class="headerlink" href="#global-and-local-motion-planning" title="Permalink to this headline"></a></h3>
<p>To get a global motion planning solution, the <em>Global Planner Component</em> needs to be activated via the <em>Global Planning Action Server</em>. When it receives a <em>MotionPlanRequest</em> the component computes a motion plan with the <em>Global Planner Plugin</em> and publishes the solution to the other components.
The dataflow within the component can be seen in the picture below:</p>
<a class="reference internal image-reference" href="../../../_images/global_planner_dataflow.png"><img alt="../../../_images/global_planner_dataflow.png" src="../../../_images/global_planner_dataflow.png" style="width: 500pt;" /></a>
<p>The <em>Global Planner Plugin</em> can be used to implement and customize the global planning algorithm. To implement you own planner you simply need to inherit from the <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/global_planner/global_planner_component/include/moveit/global_planner/global_planner_interface.h">GlobalPlannerInterface</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MySmartPlanner</span> <span class="p">:</span> <span class="n">public</span> <span class="n">GlobalPlannerInterface</span>
<span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="o">//</span> <span class="n">Constructor</span> <span class="ow">and</span> <span class="n">Destructor</span> <span class="o">-</span> <span class="n">Don</span><span class="s1">&#39;t forget to define it!</span>
  <span class="n">MySmartPlanner</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>
  <span class="o">~</span><span class="n">MySmartPlanner</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">when</span> <span class="n">your</span> <span class="n">plugin</span> <span class="ow">is</span> <span class="n">loaded</span>
  <span class="nb">bool</span> <span class="n">initialize</span><span class="p">(</span><span class="n">const</span> <span class="n">rclcpp</span><span class="p">::</span><span class="n">Node</span><span class="p">::</span><span class="n">SharedPtr</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Defines</span> <span class="n">how</span> <span class="n">the</span> <span class="n">planner</span> <span class="n">solves</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">planning</span> <span class="n">problem</span>
  <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">MotionPlanResponse</span>
  <span class="n">plan</span><span class="p">(</span><span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rclcpp_action</span><span class="p">::</span><span class="n">ServerGoalHandle</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">GlobalPlanner</span><span class="o">&gt;&gt;</span> <span class="n">global_goal_handle</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">when</span> <span class="k">global</span> <span class="n">planning</span> <span class="ow">is</span> <span class="n">aborted</span> <span class="ow">or</span> <span class="n">finished</span>
  <span class="nb">bool</span> <span class="n">reset</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><em>Global Planner</em> example implementations can be found <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/global_planner/global_planner_plugins/">here</a>.</p>
<p>More complex is the behavior of the <em>Local Planner Component</em>. The data flow is displayed below:</p>
<a class="reference internal image-reference" href="../../../_images/local_planner_dataflow.png"><img alt="../../../_images/local_planner_dataflow.png" src="../../../_images/local_planner_dataflow.png" style="width: 500pt;" /></a>
<p>The local planner is started and stopped via the <em>Local Planning Action Server</em>. After the component is started it performs each iteration the following tasks:</p>
<ol class="arabic simple">
<li><p>Fetch the local planning problem based on the current state by calling <em>getLocalTrajectory()</em></p></li>
<li><p>Solve the local planning problem defined by the desired local trajectory and optional additional constraints as defined by the <em>Local Solver Plugin</em></p></li>
<li><p>Publish the local solution as <em>JointTrajectory</em> or <em>Float64MultiArray</em> message</p></li>
</ol>
<p>Via the <em>Global Solution Subscriber</em> the <em>Local Planner Component</em> receives global planning updates which are processed and blended into the reference trajectory. Based on this reference trajectory the local planner identifies and solves local planning problems once it is started. How the global trajectory updates are processed and included into the reference trajectory is defined by the <em>Trajectory Operator</em> ‘s <em>addTrajectorySegment()</em> function.</p>
<p>The behavior of the <em>Local Planner Component</em> can be customized via the <em>Trajectory Operator Plugin</em> and the local <em>Solver Plugin</em>:</p>
<p>The <em>Trajectory Operator Plugin</em> handles the reference trajectory. To create your own operator you need to create a plugin class which inherits from the <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/local_planner/local_planner_component/include/moveit/local_planner/trajectory_operator_interface.h">TrajectoryOperatorInterface</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyAwesomeOperator</span> <span class="p">:</span> <span class="n">public</span> <span class="n">TrajectoryOperatorInterface</span>
<span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="o">//</span> <span class="n">Constructor</span> <span class="ow">and</span> <span class="n">Destructor</span> <span class="o">-</span> <span class="n">Don</span><span class="s1">&#39;t forget to define it!</span>
  <span class="n">MyAwesomeOperator</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>
  <span class="o">~</span><span class="n">MyAwesomeOperator</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">when</span> <span class="n">your</span> <span class="n">plugin</span> <span class="ow">is</span> <span class="n">loaded</span>
  <span class="nb">bool</span> <span class="n">initialize</span><span class="p">(</span><span class="n">const</span> <span class="n">rclcpp</span><span class="p">::</span><span class="n">Node</span><span class="p">::</span><span class="n">SharedPtr</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="n">const</span> <span class="n">moveit</span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">RobotModelConstPtr</span><span class="o">&amp;</span> <span class="n">robot_model</span><span class="p">,</span>
                  <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">group_name</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
  <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">LocalPlanner</span><span class="p">::</span><span class="n">Feedback</span>

  <span class="o">//</span> <span class="n">Process</span> <span class="k">global</span> <span class="n">trajectory</span> <span class="n">updates</span>
  <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">LocalPlanner</span><span class="p">::</span><span class="n">Feedback</span>
  <span class="n">addTrajectorySegment</span><span class="p">(</span><span class="n">const</span> <span class="n">robot_trajectory</span><span class="p">::</span><span class="n">RobotTrajectory</span><span class="o">&amp;</span> <span class="n">new_trajectory</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Sample</span> <span class="n">the</span> <span class="n">local</span> <span class="n">planning</span> <span class="n">problem</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">reference</span> <span class="n">trajectory</span>
  <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">LocalPlanner</span><span class="p">::</span><span class="n">Feedback</span>
  <span class="n">getLocalTrajectory</span><span class="p">(</span><span class="n">const</span> <span class="n">moveit</span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">RobotState</span><span class="o">&amp;</span> <span class="n">current_state</span><span class="p">,</span>
                     <span class="n">robot_trajectory</span><span class="p">::</span><span class="n">RobotTrajectory</span><span class="o">&amp;</span> <span class="n">local_trajectory</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Optional</span> <span class="n">but</span> <span class="n">can</span> <span class="n">be</span> <span class="n">useful</span> <span class="k">for</span> <span class="n">the</span> <span class="n">algorithm</span> <span class="n">you</span><span class="s1">&#39;re using</span>
  <span class="n">double</span> <span class="n">getTrajectoryProgress</span><span class="p">(</span><span class="n">const</span> <span class="n">moveit</span><span class="p">::</span><span class="n">core</span><span class="p">::</span><span class="n">RobotState</span><span class="o">&amp;</span> <span class="n">current_state</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">when</span> <span class="n">local</span> <span class="n">planning</span> <span class="ow">is</span> <span class="n">aborted</span> <span class="ow">or</span> <span class="n">re</span><span class="o">-</span><span class="n">invoked</span>
  <span class="nb">bool</span> <span class="n">reset</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><em>Trajectory Operator</em> example implementations can be found <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/local_planner/trajectory_operator_plugins/">here</a>.</p>
<p>The <em>Local Solver Plugin</em> implements the algorithm to solve the local planning problem each iteration. To implement your solution you need to inherit from the <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/local_planner/local_planner_component/include/moveit/local_planner/local_constraint_solver_interface.h">LocalConstraintSolverInterface</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyAwesomeSolver</span> <span class="p">:</span> <span class="n">public</span> <span class="n">LocalConstraintSolverInterface</span>
<span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="o">//</span> <span class="n">Constructor</span> <span class="ow">and</span> <span class="n">Destructor</span> <span class="o">-</span> <span class="n">Don</span><span class="s1">&#39;t forget to define it!</span>
  <span class="n">MyAwesomeSolver</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>
  <span class="o">~</span><span class="n">MyAwesomeSolver</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">when</span> <span class="n">your</span> <span class="n">plugin</span> <span class="ow">is</span> <span class="n">loaded</span>
  <span class="nb">bool</span> <span class="n">initialize</span><span class="p">(</span><span class="n">const</span> <span class="n">rclcpp</span><span class="p">::</span><span class="n">Node</span><span class="p">::</span><span class="n">SharedPtr</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span>
                  <span class="n">const</span> <span class="n">planning_scene_monitor</span><span class="p">::</span><span class="n">PlanningSceneMonitorPtr</span><span class="o">&amp;</span> <span class="n">planning_scene_monitor</span><span class="p">,</span>
                  <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">group_name</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">called</span> <span class="n">when</span> <span class="n">the</span> <span class="n">local</span> <span class="n">planning</span> <span class="ow">is</span> <span class="n">aborted</span> <span class="ow">or</span> <span class="n">re</span><span class="o">-</span><span class="n">invoked</span>
  <span class="nb">bool</span> <span class="n">reset</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Within</span> <span class="n">this</span> <span class="n">function</span> <span class="n">the</span> <span class="n">local</span> <span class="n">planning</span> <span class="n">problem</span> <span class="ow">is</span> <span class="n">solved</span><span class="o">.</span>
  <span class="o">//</span> <span class="n">Conversation</span> <span class="n">into</span> <span class="n">the</span> <span class="n">configured</span> <span class="n">msg</span> <span class="nb">type</span> <span class="ow">is</span> <span class="n">handled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">local</span> <span class="n">planner</span> <span class="n">component</span>
  <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">LocalPlanner</span><span class="p">::</span><span class="n">Feedback</span>
  <span class="n">solve</span><span class="p">(</span><span class="n">const</span> <span class="n">robot_trajectory</span><span class="p">::</span><span class="n">RobotTrajectory</span><span class="o">&amp;</span> <span class="n">local_trajectory</span><span class="p">,</span>
        <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">const</span> <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">LocalPlanner</span><span class="p">::</span><span class="n">Goal</span><span class="o">&gt;</span> <span class="n">local_goal</span><span class="p">,</span>
        <span class="n">trajectory_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">JointTrajectory</span><span class="o">&amp;</span> <span class="n">local_solution</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><em>Local Constraint Solver</em> example implementations can be found <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/local_planner/local_constraint_solver_plugins/">here</a>.</p>
<p>Both plugins receive a shared pointer to the ROS 2 node when they get initialized which can be used to create additional custom ROS 2 communication interfaces for example to subscribe to an additional sensor source.</p>
</div>
<div class="section" id="planning-logic-and-reactive-behavior">
<h3>Planning Logic and Reactive Behavior<a class="headerlink" href="#planning-logic-and-reactive-behavior" title="Permalink to this headline"></a></h3>
<p>Besides the possibility to combine global and local motion planner, this architecture enables the robot to react online to events. You can customize this behavior with the <em>Planning Logic Plugin</em>. A simple example for a <em>Hybrid Planner Logic</em> can be seen in the next figure:</p>
<a class="reference internal image-reference" href="../../../_images/logical_flow.png"><img alt="../../../_images/logical_flow.png" src="../../../_images/logical_flow.png" style="width: 500pt;" /></a>
<p>Events are discrete signals that trigger a callback function within the <em>Hybrid Planning Manager</em>. ROS 2 action feedback, action results and topics are used as event channels. Important to mention is, that the action feedback from the planner nodes to the <em>Hybrid Planning Manager</em> is <strong>not</strong> used to return feedback but to trigger reactions to events that occur while an action is active.
An example would be an unforeseen collision object during the online local planning: The <em>Local Planner Component</em> sends a “collision object ahead” event message via the action feedback channel to the <em>Hybrid Planning Manager</em> but whether the current local planning action is aborted or just the reference trajectory updated is decided by the <em>Planner Logic Plugin</em> in the <em>Hybrid Planning Manager</em>.</p>
<p>The callback function an event channel in the <em>Hybrid Planning Manager</em> looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Local</span> <span class="n">planner</span> <span class="n">action</span> <span class="n">feedback</span> <span class="n">callback</span>
<span class="n">local_goal_options</span><span class="o">.</span><span class="n">feedback_callback</span> <span class="o">=</span>
    <span class="p">[</span><span class="n">this</span><span class="p">](</span><span class="n">rclcpp_action</span><span class="p">::</span><span class="n">ClientGoalHandle</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">LocalPlanner</span><span class="o">&gt;</span><span class="p">::</span><span class="n">SharedPtr</span> <span class="o">/*</span><span class="n">unused</span><span class="o">*/</span><span class="p">,</span>
           <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">const</span> <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">LocalPlanner</span><span class="p">::</span><span class="n">Feedback</span><span class="o">&gt;</span> <span class="n">local_planner_feedback</span><span class="p">)</span> <span class="p">{</span>

      <span class="o">//</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">planner</span> <span class="n">plugin</span><span class="s1">&#39;s react function with a given event string</span>
      <span class="n">ReactionResult</span> <span class="n">reaction_result</span> <span class="o">=</span> <span class="n">planner_logic_instance_</span><span class="o">-&gt;</span><span class="n">react</span><span class="p">(</span><span class="n">local_planner_feedback</span><span class="o">-&gt;</span><span class="n">feedback</span><span class="p">);</span>

      <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">successful</span><span class="p">,</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">hybrid</span> <span class="n">planning</span> <span class="n">action</span> <span class="ow">is</span> <span class="n">aborted</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">reaction_result</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span> <span class="o">!=</span> <span class="n">moveit_msgs</span><span class="p">::</span><span class="n">msg</span><span class="p">::</span><span class="n">MoveItErrorCodes</span><span class="p">::</span><span class="n">SUCCESS</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="p">::</span><span class="n">action</span><span class="p">::</span><span class="n">HybridPlanning</span><span class="p">::</span><span class="n">Result</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="n">result</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">reaction_result</span><span class="o">.</span><span class="n">error_code</span><span class="o">.</span><span class="n">val</span><span class="p">;</span>
        <span class="n">result</span><span class="o">-&gt;</span><span class="n">error_message</span> <span class="o">=</span> <span class="n">reaction_result</span><span class="o">.</span><span class="n">error_message</span><span class="p">;</span>
        <span class="n">hybrid_planning_goal_handle_</span><span class="o">-&gt;</span><span class="n">abort</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">LOGGER</span><span class="p">,</span> <span class="s2">&quot;Hybrid Planning Manager failed to react to  &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">reaction_result</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">c_str</span><span class="p">());</span>
      <span class="p">}</span>
    <span class="p">};</span>
</pre></div>
</div>
<p>To create you own <em>Planner Logic Plugin</em> you need inherit from the <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/hybrid_planning_manager/hybrid_planning_manager_component/include/moveit/hybrid_planning_manager/planner_logic_interface.h">PlannerLogicInterface</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyCunningLogic</span> <span class="p">:</span> <span class="n">public</span> <span class="n">PlannerLogicInterface</span>
<span class="p">{</span>
<span class="n">public</span><span class="p">:</span>
  <span class="o">//</span> <span class="n">Brief</span> <span class="n">constructor</span> <span class="ow">and</span> <span class="n">destructor</span>
  <span class="n">MyCunningLogic</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>
  <span class="o">~</span><span class="n">MyCunningLogic</span><span class="p">()</span> <span class="o">=</span> <span class="n">default</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">The</span> <span class="n">plugin</span> <span class="n">needs</span> <span class="n">a</span> <span class="n">shared</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">hybrid</span> <span class="n">planning</span> <span class="n">manager</span> <span class="n">to</span> <span class="n">access</span> <span class="n">its</span> <span class="n">member</span> <span class="n">functions</span> <span class="n">like</span> <span class="n">planGlobalTrajectory</span><span class="p">()</span>
  <span class="nb">bool</span> <span class="n">initialize</span><span class="p">(</span><span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">moveit_hybrid_planning</span><span class="p">::</span><span class="n">HybridPlanningManager</span><span class="o">&gt;&amp;</span> <span class="n">hybrid_planning_manager</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">implement</span> <span class="n">reaction</span> <span class="n">to</span> <span class="n">some</span> <span class="n">default</span> <span class="n">Hybrid</span> <span class="n">Planning</span> <span class="n">events</span>
  <span class="n">ReactionResult</span> <span class="n">react</span><span class="p">(</span><span class="n">const</span> <span class="n">BasicHybridPlanningEvent</span><span class="o">&amp;</span> <span class="n">event</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Here</span> <span class="n">are</span> <span class="n">reactions</span> <span class="n">to</span> <span class="n">custom</span> <span class="n">events</span> <span class="n">encoded</span> <span class="k">as</span> <span class="n">string</span> <span class="n">implemented</span>
  <span class="n">ReactionResult</span> <span class="n">react</span><span class="p">(</span><span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">event</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>A possible implementation of the <em>react()</em> function could contain a switch-case statement that maps events to actions like in the <a class="reference external" href="https://github.com/ros-planning/moveit2/blob/main/moveit_ros/hybrid_planning/hybrid_planning_manager/hybrid_planning_manager_component/include/moveit/hybrid_planning_manager/planner_logic_interface.h">example logic plugins</a>.</p>
</div>
</div>
</div>



           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../dual_arms/dual_arms_tutorial.html" class="btn btn-neutral float-left" title="Dual Arms with MoveIt" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../realtime_servo/realtime_servo_tutorial.html" class="btn btn-neutral float-right" title="Realtime Arm Servoing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, PickNik Robotics.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-108532843-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-108532843-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>