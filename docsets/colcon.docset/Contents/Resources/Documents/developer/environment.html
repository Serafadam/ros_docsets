<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Environment setup &mdash; colcon  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/colcon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Program flow" href="program-flow.html" />
    <link rel="prev" title="Bootstrap from source" href="bootstrap.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/colcon.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/quick-start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/how-to.html">How to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/what-is-a-workspace.html">What is a Workspace?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/log-files.html">Log Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/isolated-vs-merged-workspaces.html">Isolated vs Merged Workspaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/using-multiple-workspaces.html">Using Multiple Workspaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/overriding-packages.html">Overriding Packages</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/build.html"><code class="docutils literal notranslate"><span class="pre">build</span></code> - Build Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/edit.html"><code class="docutils literal notranslate"><span class="pre">edit</span></code> - Edit File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/graph.html"><code class="docutils literal notranslate"><span class="pre">graph</span></code> - Visualize Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/info.html"><code class="docutils literal notranslate"><span class="pre">info</span></code> - Show Package Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/list.html"><code class="docutils literal notranslate"><span class="pre">list</span></code> - List Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/metadata.html"><code class="docutils literal notranslate"><span class="pre">metadata</span></code> - Manage metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/mixin.html"><code class="docutils literal notranslate"><span class="pre">mixin</span></code> - Manage mixins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/test.html"><code class="docutils literal notranslate"><span class="pre">test</span></code> - Test Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/verb/test-result.html"><code class="docutils literal notranslate"><span class="pre">test-result</span></code> - Summarize Test Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/global-arguments.html">Global arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/executor-arguments.html">Executor arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/event-handler-arguments.html">Event handler arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/discovery-arguments.html">Discovery arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/package-selection-arguments.html">Package selection arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/mixin-arguments.html">Mixin arguments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootstrap.html">Bootstrap from source</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Environment setup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#entry-points">Entry points</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#package-level">Package-level</a></li>
<li class="toctree-l3"><a class="reference internal" href="#workspace-level">Workspace-level</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#different-shells">Different shells</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#primary-shells">Primary shells</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-primary-additional-shells">Non-primary / additional shells</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#avoid-duplicate-entries">Avoid duplicate entries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dsv-files">.dsv files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tracing">Tracing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="program-flow.html">Program flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="extension-point.html">Extension points</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribution.html">Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">Make Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Migrate from other build tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../migration/ament_tools.html">ament_tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration/catkin_make_isolated.html">catkin_make_isolated</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration/catkin_tools.html">catkin_tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">colcon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Environment setup</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer/environment.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="environment-setup">
<h1>Environment setup<a class="headerlink" href="#environment-setup" title="Permalink to this headline"></a></h1>
<p>Using a package after it has been built or building a package on top of its dependencies might require updating environment variables.
For the former, the best option for the user is to have a script perform the environment update for ease of use.
In the latter case, automating the process is necessary to build packages in topological order without user interaction.
E.g. if a package installs an executable which should be invocable by name, the directory containing the executable needs to be part of the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> environment variable.</p>
<div class="section" id="entry-points">
<h2>Entry points<a class="headerlink" href="#entry-points" title="Permalink to this headline"></a></h2>
<p>To update environment variables:</p>
<ul class="simple">
<li><p>On non-Windows platforms a shell script needs to be <code class="docutils literal notranslate"><span class="pre">source</span></code>-ed (e.g. <code class="docutils literal notranslate"><span class="pre">.sh</span></code>, <code class="docutils literal notranslate"><span class="pre">.bash</span></code>, <code class="docutils literal notranslate"><span class="pre">.zsh</span></code>)</p></li>
<li><p>On Windows a shell script needs to be <code class="docutils literal notranslate"><span class="pre">call</span></code>-ed (e.g. <code class="docutils literal notranslate"><span class="pre">.bat</span></code>, <code class="docutils literal notranslate"><span class="pre">.ps1</span></code>)</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Executables are unable to change the environment of the current shell.
Therefore this needs to be done from a shell script.</p>
</div>
<div class="section" id="package-level">
<h3>Package-level<a class="headerlink" href="#package-level" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each package installs its files under its install prefix.
This corresponds to <code class="docutils literal notranslate"><span class="pre">install/&lt;package_name&gt;</span></code> except when <code class="docutils literal notranslate"><span class="pre">colcon</span> <span class="pre">build</span> <span class="pre">--merge-install</span></code> is used.
In that case, the install prefix is <code class="docutils literal notranslate"><span class="pre">install/</span></code>.</p>
</div>
<p>For each built package <code class="docutils literal notranslate"><span class="pre">colcon</span></code> generates a set of package-level scripts (one for each supported shell type): <code class="docutils literal notranslate"><span class="pre">share/&lt;package_name&gt;/package.&lt;ext&gt;</span></code>.
These script files update the environment with information specific to this package.</p>
<p><code class="docutils literal notranslate"><span class="pre">colcon</span></code> supports multiple different approaches to update environment variables:</p>
<ul class="simple">
<li><p>A heuristic checking the installed files for known file types or known destinations.
A few of the supported heuristics:</p>
<ul>
<li><p>An executable under <code class="docutils literal notranslate"><span class="pre">bin</span></code> adds that directory to the <code class="docutils literal notranslate"><span class="pre">PATH</span></code></p></li>
<li><p>An existing Python library directory adds that directory to the <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></p></li>
<li><p>A file ending in <code class="docutils literal notranslate"><span class="pre">-config.cmake</span></code> or <code class="docutils literal notranslate"><span class="pre">Config.cmake</span></code> adds the directory to the <code class="docutils literal notranslate"><span class="pre">CMAKE_PREFIX_PATH</span></code> (provided by <code class="docutils literal notranslate"><span class="pre">colcon-cmake</span></code>)</p></li>
<li><p>A file starting with <code class="docutils literal notranslate"><span class="pre">Find</span></code> and ending in <code class="docutils literal notranslate"><span class="pre">.cmake</span></code> adds the directory to the <code class="docutils literal notranslate"><span class="pre">CMAKE_MODULE_PATH</span></code> (provided by <code class="docutils literal notranslate"><span class="pre">colcon-cmake</span></code>)</p></li>
<li><p>A shared library adds the directory to one of the following environment variables (depending on the platform): <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code>, <code class="docutils literal notranslate"><span class="pre">DYLD_LIBRARY_PATH</span></code>, <code class="docutils literal notranslate"><span class="pre">PATH</span></code> (provided by <code class="docutils literal notranslate"><span class="pre">colcon-library-path</span></code>)</p></li>
<li><p>A file ending in <code class="docutils literal notranslate"><span class="pre">.pc</span></code> in a directory <code class="docutils literal notranslate"><span class="pre">lib/pkgconfig</span></code> adds the directory to the <code class="docutils literal notranslate"><span class="pre">PKG_CONFIG_PATH</span></code> (provided by <code class="docutils literal notranslate"><span class="pre">colcon-pkg-config</span></code>)</p></li>
</ul>
</li>
<li><p>Specific package types providing their own scripts to setup the package specific environment.
E.g. <code class="docutils literal notranslate"><span class="pre">ament_cmake</span></code> packages (supported by <code class="docutils literal notranslate"><span class="pre">colcon-ros</span></code>) provide a file named <code class="docutils literal notranslate"><span class="pre">share/&lt;package_name&gt;/local_setup.&lt;ext&gt;</span></code>.</p></li>
</ul>
</div>
<div class="section" id="workspace-level">
<h3>Workspace-level<a class="headerlink" href="#workspace-level" title="Permalink to this headline"></a></h3>
<p>In the root of the install prefix path, <code class="docutils literal notranslate"><span class="pre">colcon</span></code> generates two kinds of scripts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">local_setup.&lt;ext&gt;</span></code>: updates the environment with information from all packages installed under this prefix path.
Since package-level scripts rely on information from their dependencies the package-level scripts must be invoked in topological order.
In order to determine the topological order of all packages under the prefix path, <code class="docutils literal notranslate"><span class="pre">colcon</span></code> stores all run dependencies of a package in a file named <code class="docutils literal notranslate"><span class="pre">share/colcon-core/packages/&lt;package_name&gt;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">setup.&lt;ext&gt;</span></code>: first invokes the <code class="docutils literal notranslate"><span class="pre">local_setup.&lt;ext&gt;</span></code> files from all parent prefix paths and then invokes the sibling <code class="docutils literal notranslate"><span class="pre">local_setup.&lt;ext&gt;</span></code> file.</p></li>
</ul>
</div>
</div>
<div class="section" id="different-shells">
<h2>Different shells<a class="headerlink" href="#different-shells" title="Permalink to this headline"></a></h2>
<p>Each shell has a potentially different syntax and supports a different set of features.
Some environment changes like extending the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> are applicable to all shells while others like providing completion functionality are only applicable to some.
If one shell (e.g. <code class="docutils literal notranslate"><span class="pre">bash</span></code>) provides a superset of functionality and syntax of another shell (e.g. <code class="docutils literal notranslate"><span class="pre">sh</span></code>) the logic of the <code class="docutils literal notranslate"><span class="pre">.sh</span></code> scripts doesn’t have to be duplicated for <code class="docutils literal notranslate"><span class="pre">bash</span></code> but can be invoked from the package-level setup files.
The latter shell is called a <em>primary shell</em>.</p>
<div class="section" id="primary-shells">
<h3>Primary shells<a class="headerlink" href="#primary-shells" title="Permalink to this headline"></a></h3>
<p>All environment changes necessary to use a package should be expressed in script with the extension of a primary shell.
Primary shell extensions are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.sh</span></code>: plain shell</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.bat</span></code>: Windows cmd</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.ps1</span></code>: PowerShell</p></li>
</ul>
</div>
<div class="section" id="non-primary-additional-shells">
<h3>Non-primary / additional shells<a class="headerlink" href="#non-primary-additional-shells" title="Permalink to this headline"></a></h3>
<p>Other shells which are able to invoke primary shell scripts within their context commonly don’t duplicate their content and logic.
Instead they first invoke the primary shell script and then add additional logic to provide specific functionalities like completion.</p>
</div>
</div>
<div class="section" id="avoid-duplicate-entries">
<h2>Avoid duplicate entries<a class="headerlink" href="#avoid-duplicate-entries" title="Permalink to this headline"></a></h2>
<p>Several environment variables store multiple values separated by a delimiter.
Commonly, duplicate values are not useful and only increase length and decrease readability.
Therefore, shell scripts try to avoid adding duplicate values where applicable.</p>
<p>With the number of values in such an environment variable the cost to check if a given value is already in the collection increases.
This significantly affects the time it takes to <code class="docutils literal notranslate"><span class="pre">source</span></code> / <code class="docutils literal notranslate"><span class="pre">call</span></code> the workspace-level setup file since for each attempt to update an environment variable the collection needs to be split and each existing value compared to the to-be-added value.</p>
<p>Therefore <code class="docutils literal notranslate"><span class="pre">colcon</span></code> provides an alternative way to update the environment.</p>
<div class="section" id="dsv-files">
<h3>.dsv files<a class="headerlink" href="#dsv-files" title="Permalink to this headline"></a></h3>
<p>Since shell scripts can contain arbitrary logic it is opaque from the outside how they affect the environment.
That makes it impossible to optimize their execution.</p>
<p>Most scripts perform one of the following common operations:</p>
<ul class="simple">
<li><p>Set an environment variable to a value.</p></li>
<li><p>Add a value to an environment variable (using a platform specific delimiter) if the value is not already in the collection.</p></li>
<li><p>Source / call another script file.</p></li>
</ul>
<p>A <code class="docutils literal notranslate"><span class="pre">.dsv</span></code> file contains the descriptive information about the intended environment change (instead of shell specific logic).
The content of such a file uses a semicolon as the delimiter and contains a single line.
The first value is the <code class="docutils literal notranslate"><span class="pre">type</span></code> of the operation followed by a variable number of arguments specific to the operation.</p>
<p>The following list enumerates the supported types and their arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">prepend-non-duplicate;&lt;name&gt;;&lt;value&gt;</span></code>: Prepend a value <code class="docutils literal notranslate"><span class="pre">&lt;value&gt;</span></code> to an environment variable <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;</span></code> (using a platform specific delimiter) if the value is not already in the collection.
The value is considered to be a path.
If the value is not an absolute path the prefix path of the <code class="docutils literal notranslate"><span class="pre">.dsv</span></code> file is prepended to the value.
An empty value therefore represents the prefix path.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prepend-non-duplicate-if-exists;&lt;name&gt;;&lt;value&gt;</span></code>: Same as <code class="docutils literal notranslate"><span class="pre">prepend-non-duplicate</span></code> but only if the path described by the value exists.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set;&lt;name&gt;;&lt;value&gt;</span></code>: Set an environment variable <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;</span></code> to a value <code class="docutils literal notranslate"><span class="pre">&lt;value&gt;</span></code>.
If the value is an existing relative path in the install prefix the install prefix is prepended to the value.
Otherwise the value is used as is.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">set-if-unset;&lt;name&gt;;&lt;value&gt;</span></code>: Same as <code class="docutils literal notranslate"><span class="pre">set</span></code>  but only if the environment variable is not yet set (or empty).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source;&lt;path&gt;</span></code>: Source / call another script file <code class="docutils literal notranslate"><span class="pre">&lt;path&gt;</span></code>.
If the value is not an absolute path the prefix path of the <code class="docutils literal notranslate"><span class="pre">.dsv</span></code> file is prepended.</p></li>
</ul>
</div>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline"></a></h2>
<p>Implementing the logic to determine the topological order of packages in every primary shell would be a lot of effort and (depending on the shell) cumbersome.
Also parsing and interpreting <code class="docutils literal notranslate"><span class="pre">.dsv</span></code> files would likely not be much faster than invoking the native scripts.</p>
<p>Therefore both parts are implemented in a Python script located in the root of the install prefix: <code class="docutils literal notranslate"><span class="pre">_local_setup_util_&lt;ext&gt;.py</span></code>.
The Python script itself can’t change the environment.
However, it is able to efficiently interpret the operations described by the <code class="docutils literal notranslate"><span class="pre">.dsv</span></code> files and generate the shell specific commands necessary to update the environment.
The Python file is templated with information specific to the primary shell it’s used from, hence the <code class="docutils literal notranslate"><span class="pre">&lt;ext&gt;</span></code> in the filename.</p>
</div>
<div class="section" id="tracing">
<h2>Tracing<a class="headerlink" href="#tracing" title="Permalink to this headline"></a></h2>
<p>When sourcing / calling a workspace-level setup file the number of evaluated scripts and / or interpreted <code class="docutils literal notranslate"><span class="pre">.dsv</span></code> files can be significant.
To debug what files are being considered in which order and what environment changes are being performed you can prepend the invocation with <code class="docutils literal notranslate"><span class="pre">COLCON_TRACE=1</span></code>.
As a result each recursively invoked script as well as every generated command will be printed to the terminal.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="bootstrap.html" class="btn btn-neutral float-left" title="Bootstrap from source" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="program-flow.html" class="btn btn-neutral float-right" title="Program flow" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, Dirk Thomas, licensed under the Creative Commons Attribution 4.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>